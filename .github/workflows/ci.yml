name: CI - Lint and Security

# Overview
# This workflow is optimized for fast feedback (~10s on small diffs) while
# keeping results easy to read. It splits into 3 focused jobs:
#  - Python • Ruff: format + lint Python
#  - Templates • djLint: check Jinja templates
#  - Security • Bandit & pip-audit: basic SAST and dependency CVEs
#
# Key speed techniques used here:
#  - Only run jobs when relevant files change (paths-filter)
#  - Use setup-python's built-in pip cache for tool installs
#  - Keep steps minimal and pinned for reproducibility and cold-start speed
#  - Continue steps to always produce a readable summary, then fail at the end

on:
  push:
  pull_request:

# Concurrency ensures only the latest run for a branch/PR is active.
# This saves CI minutes and keeps signal relevant when pushing quickly.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege - workflows default to broad permissions.
permissions:
  contents: read

# Use bash for conditional summaries
defaults:
  run:
    shell: bash

jobs:
  python-lint:
    name: Python • Ruff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Checkout is required so tools can read files. v4 is the current
        # major and is well-cached on GitHub runners.

      # Run only when Python files or Ruff config changed
      # Paths-filter sets outputs we can branch on. If nothing relevant
      # changed, we skip the expensive steps and summarize as "Skipped".
      - name: Filter paths (Python)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - '**/*.py'
              - '.ruff.toml'

      # Built-in pip cache for faster installs
      # The cache reuses downloaded wheels between runs to speed up pip installs.
      # Sticking to one Python version maximizes cache hit rate.
      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          
      # Pin versions for reproducibility and stable annotations.
      # Tip: update periodically to pick up new rules/perf.
      - name: Install Ruff (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "ruff==0.5.7"

      # Auto-fix imports/format; final verify emits GitHub annotations
      - name: Ruff (auto-fix, then verify)
        id: ruff
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          ruff check . --fix
          ruff format .
          ruff check . --output-format=github
        # Ruff runs twice:
        #  1) ruff check --fix and ruff format to apply safe auto-fixes.
        #  2) ruff check (no --fix) to produce GitHub annotations.
        # continue-on-error keeps the job alive so we can write a clean summary
        # and fail at the end based on the step outcome.

      - name: Summary (Python • Ruff)
        run: |
          echo "## Python • Ruff" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no Python changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          s="${{ steps.ruff.outcome }}"
          echo "- Ruff: $s" >> "$GITHUB_STEP_SUMMARY"
          [ "$s" = "failure" ] && exit 1 || exit 0
        # We intentionally gate the final exit code here instead of failing
        # earlier. That guarantees a human-friendly section in the job summary
        # even when lint errors exist.

  template-lint:
    name: Templates • djLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run only when templates changed
      - name: Filter paths (Templates)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - 'templates/**'

      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

        # djLint supports multiple templating engines. We use the Jinja profile
        # to lint Flask/Jinja templates.
      - name: Install djLint (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "djlint==1.36.4"

      - name: djLint (Jinja profile)
        id: djlint
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: djlint templates --check --profile=jinja
        # --check makes it fail on style issues (no auto-fix). We keep
        # continue-on-error to always emit a summary before deciding pass/fail.

      - name: Summary (Templates • djLint)
        run: |
          echo "## Templates • djLint" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no template changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          s="${{ steps.djlint.outcome }}"
          echo "- djLint: $s" >> "$GITHUB_STEP_SUMMARY"
          [ "$s" = "failure" ] && exit 1 || exit 0
        # Same summary pattern: write a clear result and fail only here.

  security-audit:
    name: Security • Bandit & pip-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run on Python or dependency changes
      - name: Filter paths (Security)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - 'requirements.txt'
              - '**/*.py'

      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install security tools (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "bandit==1.7.8" "pip-audit==2.7.3"
        # Pin for consistent findings and faster cold starts.

      - name: Bandit (SAST)
        id: bandit
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          bandit -q -r . \
            --severity-level medium \
            --confidence-level medium \
            -x venv,.venv,instance,__pycache__
        # Bandit scans Python code for common security issues.
        # -q: quiet output    -r: recursive
        # We set minimum severity/confidence to "medium" to reduce noise.
        # Exclusions skip virtualenvs, runtime instance data, and caches.

      - name: pip-audit (dependency CVEs)
        id: pip_audit
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip-audit -r requirements.txt
        # Checks installed requirement versions against known CVEs.
        # For lockfiles, use the corresponding flag (e.g., -r, -P, etc.).

      - name: Summary (Security)
        run: |
          echo "## Security • Bandit & pip-audit" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no security-relevant changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          sb="${{ steps.bandit.outcome }}"; sa="${{ steps.pip_audit.outcome }}"
          echo "- Bandit: $sb" >> "$GITHUB_STEP_SUMMARY"
          echo "- pip-audit: $sa" >> "$GITHUB_STEP_SUMMARY"
          [ "$sb" = "failure" ] || [ "$sa" = "failure" ] && exit 1 || exit 0
        # We fail the job if either Bandit or pip-audit found issues serious
        # enough to set a failure. The summary always shows both results.

  tests:
    name: Tests • Pytest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Filter paths (Tests)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - '**/*.py'
              - 'tests/**'
              - 'pytest.ini'

      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "pytest==8.2.2"

      - name: Run tests (pytest)
        id: pytest
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          pytest -q

      - name: Summary (Tests • Pytest)
        run: |
          echo "## Tests • Pytest" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no relevant changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          s="${{ steps.pytest.outcome }}"
          echo "- pytest: $s" >> "$GITHUB_STEP_SUMMARY"
          [ "$s" = "failure" ] && exit 1 || exit 0