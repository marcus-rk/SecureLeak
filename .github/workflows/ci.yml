name: CI - Lint and Security

on:
  push:
  pull_request:

# Cancel redundant runs on rapid pushes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Principle of least privilege
permissions:
  contents: read

# Use bash for conditional summaries
defaults:
  run:
    shell: bash

jobs:
  python-lint:
    name: Python • Ruff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run only when Python files or Ruff config changed
      - name: Filter paths (Python)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - '**/*.py'
              - '.ruff.toml'

      # Built-in pip cache for faster installs
      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Ruff (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "ruff==0.5.7"

      # Auto-fix imports/format; final verify emits GitHub annotations
      - name: Ruff (auto-fix, then verify)
        id: ruff
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          ruff check . --fix
          ruff format .
          ruff check . --output-format=github

      - name: Summary (Python • Ruff)
        run: |
          echo "## Python • Ruff" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no Python changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          s="${{ steps.ruff.outcome }}"
          echo "- Ruff: $s" >> "$GITHUB_STEP_SUMMARY"
          [ "$s" = "failure" ] && exit 1 || exit 0

  template-lint:
    name: Templates • djLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run only when templates changed
      - name: Filter paths (Templates)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - 'templates/**'

      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install djLint (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "djlint==1.36.4"

      - name: djLint (Jinja profile)
        id: djlint
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: djlint templates --check --profile=jinja

      - name: Summary (Templates • djLint)
        run: |
          echo "## Templates • djLint" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no template changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          s="${{ steps.djlint.outcome }}"
          echo "- djLint: $s" >> "$GITHUB_STEP_SUMMARY"
          [ "$s" = "failure" ] && exit 1 || exit 0

  security-audit:
    name: Security • Bandit & pip-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Run on Python or dependency changes
      - name: Filter paths (Security)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            changed:
              - 'requirements.txt'
              - '**/*.py'

      - name: Set up Python 3.11 (pip cache)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install security tools (pinned)
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip install "bandit==1.7.8" "pip-audit==2.7.3"

      - name: Bandit (SAST)
        id: bandit
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: |
          bandit -q -r . \
            --severity-level medium \
            --confidence-level medium \
            -x venv,.venv,instance,__pycache__

      - name: pip-audit (dependency CVEs)
        id: pip_audit
        continue-on-error: true
        if: ${{ steps.filter.outputs.changed == 'true' }}
        run: pip-audit -r requirements.txt

      - name: Summary (Security)
        run: |
          echo "## Security • Bandit & pip-audit" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.changed }}" != "true" ]; then
            echo "- Skipped (no security-relevant changes)" >> "$GITHUB_STEP_SUMMARY"; exit 0; fi
          sb="${{ steps.bandit.outcome }}"; sa="${{ steps.pip_audit.outcome }}"
          echo "- Bandit: $sb" >> "$GITHUB_STEP_SUMMARY"
          echo "- pip-audit: $sa" >> "$GITHUB_STEP_SUMMARY"
          [ "$sb" = "failure" ] || [ "$sa" = "failure" ] && exit 1 || exit 0