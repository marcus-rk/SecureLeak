# Minimal Nginx config for SecureLeak — HTTPS at the proxy, app behind it.
# PURPOSE:
# - Terminate TLS here (Nginx), not in Flask.
# - Redirect all HTTP to HTTPS.
# - Set HSTS so browsers stay on HTTPS.
# - Forward requests to the Flask app (Gunicorn) running on 127.0.0.1:8000.
# - Tell Flask it's HTTPS via X-Forwarded-Proto so secure cookies/HSTS logic behave correctly.

# 1) Redirect all plaintext HTTP to HTTPS
server {
    listen 80;
    server_name example.com www.example.com;  # REPLACE with your domain
    return 301 https://$host$request_uri;     # Permanent redirect to HTTPS
}

# 2) Serve HTTPS and proxy to Flask (Gunicorn)
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;  # REPLACE with your domain

    # TLS certificates (from Let's Encrypt in a real deploy)
    # These paths are standard for Certbot. Replace example.com accordingly.
    ssl_certificate     /etc/letsencrypt/live/example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;

    # HSTS: tell browsers to only use HTTPS for future requests
    # 31536000 = 1 year. 'always' ensures it’s added on all responses.
    add_header Strict-Transport-Security "max-age=31536000" always;

    # Optional basic hardening headers (the app also sets CSP via Flask-Talisman)
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # Proxy everything to the Gunicorn app on localhost
    location / {
        proxy_pass http://127.0.0.1:8000;

        # Preserve useful client/proxy info
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;

        # CRITICAL: lets Flask/Talisman know the original request is HTTPS
        proxy_set_header X-Forwarded-Proto https;

        # Reasonable timeouts for a simple app
        proxy_connect_timeout 5s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;
    }
}
